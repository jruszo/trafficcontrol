# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

---
name: Run All Non-CIAB Tests

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Branch or tag to test (defaults to current branch)
        required: false
        default: ""
  pull_request:
    branches: [ master ]
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

permissions:
  actions: write
  contents: read

jobs:
  dispatch-test-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve target ref
        id: ref
        env:
          INPUT_REF: ${{ github.event.inputs.ref }}
          PR_HEAD_REF: ${{ github.event.pull_request.head.ref }}
        run: |
          set -o errexit -o nounset -o pipefail
          target_ref="${INPUT_REF:-}"
          if [ -z "${target_ref}" ]; then
            if [ "${GITHUB_EVENT_NAME}" = "pull_request" ] && [ -n "${PR_HEAD_REF:-}" ]; then
              target_ref="${PR_HEAD_REF}"
            else
              target_ref="${GITHUB_REF_NAME}"
            fi
          fi
          echo "target_ref=${target_ref}" >> "${GITHUB_OUTPUT}"

      - name: Trigger non-CIAB test workflows
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          TARGET_REF: ${{ steps.ref.outputs.target_ref }}
        run: |
          set -o errexit -o nounset -o pipefail

          workflows=(
            "cache-config-tests.yml"
            "cache-config.unit.tests.yml"
            "go.lib.unit.tests.yml"
            "grove.unit.tests.yml"
            "health-client-tests.yml"
            "postinstall.tests.yml"
            "tm.integration.tests.yml"
            "tm.unit.tests.yml"
            "to.api.contract.tests.yml"
            "to.integration.tests.yml"
            "to.unit.tests.yml"
            "tp.integration.tests.yml"
            "tpv2.yml"
            "tr-ultimate-test-harness.yml"
            "tr.tests.yaml"
            "traffic-stats.unit.tests.yml"
            "traffic.ops.database.yml"
          )

          for workflow in "${workflows[@]}"; do
            echo "Dispatching ${workflow} on ${TARGET_REF}"
            gh api \
              --method POST \
              -H "Accept: application/vnd.github+json" \
              "/repos/${REPO}/actions/workflows/${workflow}/dispatches" \
              -f ref="${TARGET_REF}"
          done

      - name: Print where to watch runs
        env:
          TARGET_REF: ${{ steps.ref.outputs.target_ref }}
        run: |
          set -o errexit -o nounset -o pipefail
          echo "Triggered non-CIAB test workflows for ref: ${TARGET_REF}"
          echo "Track runs at:"
          echo "https://github.com/${GITHUB_REPOSITORY}/actions?query=branch%3A${TARGET_REF}+event%3Aworkflow_dispatch"
