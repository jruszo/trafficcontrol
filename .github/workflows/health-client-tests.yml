# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

name: TC Health Client Integration Tests

env:
  ATS_VERSION: 9.2.x
  TARGET_ARCH: x86_64

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - .github/workflows/health-client-tests.yml
      - go.mod
      - go.sum
      - GO_VERSION
      - lib/go-atscfg/**.go
      - traffic_ops/*client/**.go
      - traffic_ops/toclientlib/**.go
      - lib/atscfg-go/**.go
      - traffic_ops/traffic_ops_golang/**.go
      - tc-health-client/**.go
      - tc-health-client/testing/**
      - '!**_test.go'
      - tc-health-client/**_test.go
      - vendor/**.go
      - vendor/modules.txt
      - .github/actions/build-ats-test-package/**
      - .github/actions/health-client-integration-tests/**
  pull_request:
    branches: [ master ]
    paths:
      - .github/workflows/health-client-tests.yml
      - go.mod
      - go.sum
      - GO_VERSION
      - lib/go-atscfg/**.go
      - traffic_ops/*client/**.go
      - traffic_ops/toclientlib/**.go
      - lib/atscfg-go/**.go
      - traffic_ops/traffic_ops_golang/**.go
      - tc-health-client/**.go
      - tc-health-client/testing/**
      - '!**_test.go'
      - tc-health-client/**_test.go
      - vendor/**.go
      - vendor/modules.txt
      - .github/actions/build-ats-test-package/**
      - .github/actions/health-client-integration-tests/**

jobs:
  traffic_ops:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 5
      - name: Build DEB
        uses: ./.github/actions/build-packages
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/*traffic_ops*.deb

  tc-health-client:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 5
      - name: Build DEB
        uses: ./.github/actions/build-packages
        env:
          ATC_COMPONENT: ${{ github.job }}
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/*trafficcontrol-health-client*.deb

  trafficserver:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Check Cache
        id: ats-package-cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/dist
          key: ats-package-${{ env.TARGET_ARCH }}-${{ hashFiles('cache-config/testing/docker/trafficserver/**') }}
      - name: Build ATS DEB
        if: steps.ats-package-cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/build-ats-test-package
      - name: Check ATS DEB
        run: |
          set -o errexit -o nounset -o xtrace
          ls dist/trafficserver*.deb
      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.job }}
          path: ${{ github.workspace }}/dist/trafficserver*.deb

  health-client_tests:
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    runs-on: ubuntu-latest
    needs:
      - traffic_ops
      - tc-health-client
      - trafficserver

    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Download TO DEB
        uses: actions/download-artifact@v4
        with:
          name: traffic_ops
          path: ${{ github.workspace }}/tc-health-client/testing/docker/traffic_ops
      - name: Download Health Client DEB
        uses: actions/download-artifact@v4
        with:
          name: tc-health-client
          path: ${{ github.workspace }}/tc-health-client/testing/docker/health-check-test
      - name: Download ATS DEB
        uses: actions/download-artifact@v4
        with:
          name: trafficserver
          path: ${{ github.workspace }}/tc-health-client/testing/docker/health-check-test
      - name: Display directory
        run: ls -l ${{ github.workspace }}/tc-health-client/testing/docker/health-check-test
      - name: Build health client test containers
        run: docker compose -f ${{ github.workspace }}/tc-health-client/testing/docker/docker-compose.yml build --parallel
      - name: Run health client integration tests
        uses: ./.github/actions/health-client-integration-tests
